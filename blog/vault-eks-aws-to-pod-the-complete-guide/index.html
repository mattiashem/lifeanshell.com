<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
    <link rel="icon" href="img/favicon.ico" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Spent most of my days with a shell, deploys apps, writing code ore fixing problems with automating, This is some of the stuff a work on right now " />
        <meta name="keywords" content="kubernernetes samma.io sre linux docker devops ks8 help blog fix problems" />
        <meta property="og:title" content="Lifeandshell - Mattias Hemmingsson" />
        <meta property="og:type" content="devsecops devops sre drones hacking" />
        <meta property="og:url" content="https://lifeadnshell.com" />
        <meta property="og:description" content="Lifeandshell - Mattias Hemmingsson - SRE Devops - And more " />

    <title>Mattias Hemmingsson {'rendered': 'Vault EKS / AWS to pod The complete guide'} </title>
    <!-- font icons -->
    <link rel="stylesheet" href="/assets/vendors/themify-icons/css/themify-icons.css">
    <!-- Bootstrap + Steller main styles -->
	<link rel="stylesheet" href="/assets/css/steller.css">
</head>
<body data-spy="scroll" data-target=".navbar" data-offset="40" id="home">

    <!-- Page navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" data-spy="affix" data-offset-top="0">
        <div class="container">
            <a class="navbar-brand" href="#"><img src="/img/hrb.png" alt=""></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav ml-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/blog">Blog</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/">Contact</a>
                    </li>
                </ul>
            </div>
        </div>          
    </nav>
    <!-- End of page navibation -->
    <!-- Blog Section -->
    <section id="blog" class="section">
        <div class="container text-center">
            <h6 class="subtitle"></h6>
            <p class="mb-5 pb-4"></p>

            <div class="row text-left">

    <h2>{'rendered': 'Vault EKS / AWS to pod The complete guide'}</h2>
    <p>{'rendered': '\n<p>I have bean working some time with vault and to deploy it to our EKS cluster and then to get the secrets into our pods.<br>After many hours of searching i have found out that using kube-vault and vault-env. This gude uses tarraform to setup the resources you need in AWS.</p>\n\n\n\n<p>Then deploy the kubevault with ui into to cluster that will use a s3 bucket and backend and autoseal it self during boot</p>\n\n\n\n<p>And then we use the Banzia vault web-hook to when a ENV is detected to come from vault. It connects to vault and read the store it into the pod.<br></p>\n\n\n\n<p>Resources<br><a href="https://kubevault.com/docs/v0.3.0/guides/platforms/eks/">https://kubevault.com/docs/v0.3.0/guides/platforms/eks/</a></p>\n\n\n\n<p><a href="https://banzaicloud.com/blog/inject-secrets-into-pods-vault-revisited/">https://banzaicloud.com/blog/inject-secrets-into-pods-vault-revisited/</a></p>\n\n\n\n<p><a href="https://kubevault.com/">https://kubevault.com/</a></p>\n\n\n\n<p><a href="https://www.vaultproject.io/">https://www.vaultproject.io/</a><br></p>\n\n\n\n<h2 class="wp-block-heading"><br>So what will happen</h2>\n\n\n\n<p><br>&#8211; We will have a vault running in our EKS cluster<br>&#8211; Secrets are stored in a S3 Bucket<br>&#8211; Vault keys are stored in AWS<br>&#8211; During startup vault will unseal it self<br>&#8211; When a pod starts the secrets from vault will be exposed ans a ENV settings for the pod (12 faktor style)<br><br></p>\n\n\n\n<h3 class="wp-block-heading"><br>AWS</h3>\n\n\n\n<p>Lets start with AWS and setup the resources you need. This will only create the resources for vault and you need to have your other EKS resources already done.<br>Im using terraform so this is a terraform manifest for running.</p>\n\n\n\n<pre class="wp-block-code"><code>#\n#  Create as3 bucket for the vaul secrets\n#\n\nresource "aws_s3_bucket" "vault-vault-bucket" {\n  bucket = "vault-gdtegd"\n  acl    = "private"\n\n  tags = {\n    Name        = "vault-gdtegd"\n    Environment = "prod"\n    DONT_DELETE = "true"\n  }\n}\n\n#\n# Policy for vaul service account s3 bucket\n#\n\nresource "aws_iam_policy" "vault_s3" {\n  name = "vaults3"\n  path        = "/"\n  description = "vault s3 access"\n\n\n  policy = &lt;&lt;EOF\n{\n    "Version": "2012-10-17",\n    "Statement": &#91;\n        {\n            "Sid": "VaultListBuckets",\n            "Effect": "Allow",\n            "Action": &#91;\n                "s3:ListAllMyBuckets",\n                "s3:HeadBucket"\n            ],\n            "Resource": "*"\n        },\n        {\n            "Sid": "VaultAccessBuckets",\n            "Effect": "Allow",\n            "Action": "s3:*",\n            "Resource": &#91;\n                "arn:aws:s3:::${aws_s3_bucket.vault-vault-bucket.id}",\n                "arn:aws:s3:::${aws_s3_bucket.vault-vault-bucket.id}/*"\n            ]\n        }\n    ]\n}\n        EOF\n}\n\n\n#\n# Create aws KMS key \n#\nresource "aws_kms_key" "vault" {\n  description             = "vault_key"\n}\n\n#\n# Policy for vaul service account for the KMS\n#\ndata "aws_caller_identity" "current" {}\ndata "aws_region" "current" {}\n\n\nresource "aws_iam_policy" "vault_kms" {\n  name = "vaultkms"\n  path        = "/"\n  description = "vault kms access"\n\n\n  policy = &lt;&lt;EOF\n{\n    "Version": "2012-10-17",\n    "Statement": &#91;\n        {\n            "Sid": "VaultUnsealerEncryptDecryptKms",\n            "Effect": "Allow",\n            "Action": &#91;\n                "kms:Decrypt",\n                "kms:Encrypt",\n                "kms:DescribeKey"\n            ],\n            "Resource": "arn:aws:kms:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:key/${aws_kms_key.vault.key_id}"\n        },\n        {\n            "Sid": "VaultUnsealerGetKMS",\n            "Effect": "Allow",\n            "Action": "kms:ListKeys",\n            "Resource": "*"\n        }\n    ]\n}\n        EOF\n}\n\n#\n# Policy for vaul service account for the SSM\n#\n\nresource "aws_iam_policy" "vault_ssm" {\n  name = "vaultssm"\n  path        = "/"\n  description = "vault ssm access"\n\n\n  policy = &lt;&lt;EOF\n{\n    "Version": "2012-10-17",\n    "Statement": &#91;\n        {\n            "Sid": "VaultUnsealerParametersAccess",\n            "Effect": "Allow",\n            "Action": &#91;\n                "ssm:PutParameter",\n                "ssm:DeleteParameter",\n                "ssm:GetParameters"\n            ],\n            "Resource": "arn:aws:ssm:*:*:parameter/*"\n        }\n    ]\n}\n        EOF\n}\n\n#\n# Create user \n#\nresource "aws_iam_user" "vault-k8s" {\n  name = "vault-k8s"\n  path = "/system/"\n\n  tags = {\n    used_in = "k8s"\n  }\n}\nresource "aws_iam_access_key" "vault-k8s" {\n  user = aws_iam_user.vault-k8s.name\n}\n\n#\n# Create role for vault\n#\n\nresource "aws_iam_role" "vault-k8s" {\n  name = "vault-k8s"\n\n  assume_role_policy = &lt;&lt;EOF\n{\n  "Version": "2012-10-17",\n  "Statement": &#91;\n    {\n      "Effect": "Allow",\n      "Principal": {\n        "Federated": "arn:aws:iam::{ YOUR VAULT USER ID   }:oidc-provider/oidc.eks.eu-north-1.amazonaws.com/id/{ YOUR CLUSTER ID }"\n      },\n      "Action": "sts:AssumeRoleWithWebIdentity",\n      "Condition": {\n        "StringEquals": {\n          "oidc.eks.eu-north-1.amazonaws.com/id/{ YOUR CLUSTER ID } :sub": "system:serviceaccount:vault-k8s:vault-k8s"\n        }\n      }\n    }\n  ]\n}\nEOF\n\n  tags = {\n    inused = "k8s"\n  }\n}\n\n\n#\n# Applied policy to user and role\n#\nresource "aws_iam_role_policy_attachment" "vault_s3" {\n  role       = aws_iam_role.vault-k8s.name\n  policy_arn = aws_iam_policy.vault_s3.arn\n}\nresource "aws_iam_role_policy_attachment" "vault_kms" {\n  role       = aws_iam_role.vault-k8s.name\n  policy_arn = aws_iam_policy.vault_kms.arn\n}\nresource "aws_iam_role_policy_attachment" "vault_ssm" {\n  role       = aws_iam_role.vault-k8s.name\n  policy_arn = aws_iam_policy.vault_ssm.arn\n}\n\n\nresource "aws_iam_policy_attachment" "vault_s3_u" {\n  name        = "vault_s3_u"\n  users       = &#91;"${aws_iam_user.vault-k8s.name}"]\n  policy_arn = aws_iam_policy.vault_s3.arn\n}\nresource "aws_iam_policy_attachment" "vault_kms_u" {\n  name        = "vault_kms_u"\n  users       = &#91;"${aws_iam_user.vault-k8s.name}"]\n  policy_arn = aws_iam_policy.vault_kms.arn\n}\nresource "aws_iam_policy_attachment" "vault_ssm_u" {\n  name        = "vault_ssm_u"\n  users       = &#91;"${aws_iam_user.vault-k8s.name}"]\n  policy_arn = aws_iam_policy.vault_ssm.arn\n}\n\n\n\n#\n#\n# Output\n#\noutput "vault-kms-key" {\n  value = aws_kms_key.vault.key_id\n}\n\n\noutput "secret_vault-k8s_id" {\n  value = aws_iam_access_key.vault-k8s.id\n}\noutput "secret_vault-k8s_key" {\n  value = aws_iam_access_key.vault-k8s.secret\n}</code></pre>\n\n\n\n<h3 class="wp-block-heading">Time to install the vault operator</h3>\n\n\n\n<p>I have a small bash script that setup and install the vault operator. With this i can run in in my pipeline and use it to upgrade as well.</p>\n\n\n\n<pre class="wp-block-code"><code>#!/bin/bash\n\n# Setup repos\nhelm repo add appscode https://charts.appscode.com/stable/\nhelm repo update\n\n# Install the vault operator\nhelm upgrade --install vault-operator appscode/vault-operator --version v0.3.0 --namespace kube-system\n\n#Install the vault catalog\nhelm upgrade --install vault-catalog appscode/vault-catalog --version v0.3.0 --namespace kube-system\n</code></pre>\n\n\n\n<p>We need to add an update so we can use the latest vault that today is (1.5.4)<br>create the file vaultserver-1.5.4.yaml</p>\n\n\n\n<pre class="wp-block-code"><code>apiVersion: catalog.kubevault.com/v1alpha1\nkind: VaultServerVersion\nmetadata:\nname: 1.5.4\nspec:\nvault:\nimage: vault:1.5.4\nexporter:\nimage: kubevault/vault-exporter-linux-amd64:v0.3.0\nunsealer:\nimage: kubevault/vault-unsealer:v0.3.0\nversion: 1.5.4</code></pre>\n\n\n\n<pre class="wp-block-code"><code>kubectl apply -f vaultserver-1.5.4.yaml</code></pre>\n\n\n\n<p>To verify they are installed run this command</p>\n\n\n\n<pre class="wp-block-code"><code>kubectl get crds  -n kube-system</code></pre>\n\n\n\n<p>You should see some vault names there </p>\n\n\n\n<h3 class="wp-block-heading">Time to deploy Vault</h3>\n\n\n\n<p>First we need some settings<br>&#8211; The bucket you created with terraform<br>&#8211; KeyID and secret for your vault user created with terraform<br>&#8211; KMS key <br>&#8211; Vault UI<br><br>All this should be printed when you run terraform apply.<br>Now lest move the secrets into base64</p>\n\n\n\n<pre class="wp-block-code"><code>echo -n "YOUR AWS SECRET / KEYID" | base64 \n</code></pre>\n\n\n\n<p>Create you deploy YAML</p>\n\n\n\n<pre class="wp-block-code"><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: vault-ui\n  namespace: vault\ndata:\n  vault.hcl: |\n    ui = true \n\n---\n\n---\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: vault\n---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: vault-aws-secrets\n  namespace: vault\ntype: Opaque\ndata:\n  access_key: {AWS KEY ID }\n  secret_key: {AWS SECRET}\n    \n    \n\n---    \napiVersion: kubevault.com/v1alpha1\nkind: VaultServer\nmetadata:\n  name: vault\n  namespace: vault\nspec:\n  configSource:\n    configMap:\n      name: vault-ui\n  replicas: 1\n  version: "1.5.4"\n  backend:\n    s3:\n      bucket: "{BUCKET NAME}"\n      region: "eu-north-1"\n      credentialSecret: vault-aws-secrets\n  unsealer:\n    secretShares: 4\n    secretThreshold: 2\n    mode:\n      awsKmsSsm:\n        region: "eu-north-1"\n        kmsKeyID: "{ KMS KEY ID }"\n        credentialSecret: vault-aws-secrets\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: vault-ingress\n  namespace: vault\nspec:\n  selector:\n      app: vault\n      cluster: vault\n  type: ClusterIP \n  ports:\n    - port: 443\n      name: https\n      targetPort: 8200\n---    \nkind: Ingress\napiVersion: extensions/v1beta1\nmetadata:\n  name: "vault"\n  namespace: vault\n  annotations:\n    kubernetes.io/ingress.class: "traefik"\n    cert-manager.io/cluster-issuer: "letsencrypt"\n    kubernetes.io/tls-acme: "true"\n    \nspec:\n  tls:\n  - hosts:\n    - vault.\n    secretName: vaultapps-tls\n           \n  rules:\n    - host: vault.\n        paths:\n          - path: /\n            backend:\n              serviceName: vault-ingress\n              servicePort: 443\n---\n</code></pre>\n\n\n\n<p>Now we should have a running vault that are unseal. Lets get the root token and connect to it.<br><br></p>\n\n\n\n<p>Here is a script to get the root token save it as <strong>get_vault_token.s</strong>h</p>\n\n\n\n<pre class="wp-block-code"><code>#!/bin/bash\n#\n# This will get and print out the vault root token\n# the token can then be used to make changes to vault as a admin.\n#  \n# BEFORE YOU CAN RUN THIS GIVE TERRAFORM AWS USER ADMIN RIGHTS ADD IT MANUALL THEN TERRAFORM WILL REMOVE FOR YOU\n#\n\naws ssm get-parameter --name vault-root-token --region eu-north-1 --output json | jq -r \'.Parameter.Value\' | base64 -d - > root.enc\nexport VAULT_TOKEN=$(aws kms decrypt --ciphertext-blob fileb://root.enc --output text --query Plaintext --encryption-context "Tool=vault-unsealer" --region eu-north-1 | base64 -d -)\nrm root.enc\nexport VAULT_ADDR=\'https://127.0.0.1:8200\'\n\n</code></pre>\n\n\n\n<p>To activate it run <strong>. ./get_vault_token.sh</strong>  You did see the first . &lt;- important</p>\n\n\n\n<p>Now start a kube proxy to the vault service create a file <strong>start_vault_proxy.sh</strong></p>\n\n\n\n<pre class="wp-block-code"><code>#!/bin/bash\n#\n# This will setup a vault proxy so localhost:8200 can proxy to vault\n# Fix fix tls ..\n\nkubectl port-forward service/vault 8200:8200 -n vault &amp;\necho "Need to sleep 5 to make the proxy connect"\nsleep 5</code></pre>\n\n\n\n<p>./start_vault_proxy.sh to start up the proxy it will jump into the background</p>\n\n\n\n<p>Now we can connect to vault</p>\n\n\n\n<pre class="wp-block-code"><code>vault status -tls-skip-verify</code></pre>\n\n\n\n<p>We need to have the <strong>-tls-skip-verify</strong> when we connect throw the proxy and dont have the ca cert of vault. </p>\n\n\n\n<h3 class="wp-block-heading">Client Time !</h3>\n\n\n\n<p>Now its time to get some values into vault and to connect our pods with with vault.<br>In this we are to make the following. <br>&#8211; Let vault connect to k8s to create token<br>&#8211; Create a secret in vault<br>&#8211; Create a vault policy that grant access to our secret<br>&#8211; Create a role that are restricted to the policy and to the namespace </p>\n\n\n\n<p>Allow vault to make new k8s token Verify that you have the correct service account and namespace for vault. Check in you deployments of vault.</p>\n\n\n\n<pre class="wp-block-code"><code>apiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: role-tokenreview-binding\n  namespace: default\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:auth-delegator\nsubjects:\n  - kind: ServiceAccount\n    name: vault\n    namespace: vault</code></pre>\n\n\n\n<p>Sounds complicated well here is a script i run when setup helm charts.<br>It set up what you need and also takes the values.yaml file from the helm chart and add it to vault.<br><br>It also add a lock secrets so it sill not overrite the secret with every deploy.<br><br></p>\n\n\n\n<pre class="wp-block-code"><code>#\n# This script will setup a vault to use with a namespace.\n# It will to the following\n\n#- setup vault secret in the correct path\n#- setup a k8s policy for service account in namespaces to access that path\n#- if not setup fill secrets with default values \n#\n#\n#After this script is run we can now use vaul-hook to get secrets into our pod as env\n\n\nD_DEPLOYNAME="pipeline"\n\n\n#Check so that we have a deployname \nif &#91;&#91; -n "${DEPLOYNAME}" ]]; then\nDEPLOY=$(echo $DEPLOYNAME |  sed \'s/\\(.*\\)/\\L\\1/\' | sed \'s/&#91;\\/.]/-/g\' )\n  #Cluster env is not set defult to standrad\n    echo "Set DEPLOYNAME to ${DEPLOY}"\n\n    D_DEPLOYNAME="${DEPLOY}"\nfi\n\n#Set defulat\nD_HELMCHART=$D_DEPLOYNAME\nD_NAMESPACE=$D_DEPLOYNAME\n\n\n#If we have a namespace env\nif &#91;&#91; -n "${NAMESPACE}" ]]; then\n  #Cluster env is not set defult to standrad\n  echo "Set NAMESPACE to ${NAMESPACE}"\n  D_NAMESPACE=${NAMESPACE}\nfi\n#If we have a helmchart env\nif &#91;&#91; -n "${HELMCHART}" ]]; then\n  #Cluster env is not set defult to standrad\n  echo "Set HELMCHART to ${HELMCHART}"\n  D_HELMCHART=${HELMCHART}\nfi\n\n\necho "Have we setup this namespace before ?"\nVAULT_SETUP_TEST=$(vault kv get -tls-skip-verify /kv/k8s/$D_NAMESPACE-lock/locked)\necho $VAULT_SETUP_TEST\necho ${VAULT_SETUP_TEST:0:2}\nif &#91; "${VAULT_SETUP_TEST:0:2}" == "==" ]; then\n    echo "Vault already setup"\nelse\n    echo "No vault setup lets add it"\n\n\n    echo "Lets add policy for namespace that gives read access"\n    echo \'path "kv/k8s/\'$D_NAMESPACE\'" { capabilities = &#91;"read"]}\' | vault policy write -tls-skip-verify $D_NAMESPACE -\n\n\n    echo "Create a role that grant access for the default user in the namespace"\n    vault write -tls-skip-verify auth/kubernetes/role/vault-$D_NAMESPACE bound_service_account_names=default bound_service_account_namespaces=$D_NAMESPACE policies=$D_NAMESPACE ttl=24h\n\n    echo "Write the default values form a helm chart into vault"\n    VALUESFILE="/code/helm/$D_HELMCHART/values.yaml"\n    echo "Values file URL $VALUESFILE" \n    if &#91; -f $VALUESFILE ]; then\n      echo "Adding the values file data"\n      cat $VALUESFILE | yq . | vault kv put  -tls-skip-verify /kv/k8s/$D_NAMESPACE -\n\n\n    else\n      echo "No values file foundls"\n\n    fi\n\n    echo "Added tha data lets lock it "\n    vault kv put -tls-skip-verify /kv/k8s/$D_NAMESPACE-lock/locked dontmove="OK"\n\nfi\necho "Renew token"\nvault token renew  -tls-skip-verify >> /dev/null\n\n\n\n\n</code></pre>\n\n\n\n<pre class="wp-block-code"><code>echo \'path "kv/k8s/\'$D_NAMESPACE\'" { capabilities = &#91;"read"]}\' | vault policy write -tls-skip-verify $D_NAMESPACE -</code></pre>\n\n\n\n<p><br>Here we add a vault policy that gived the accees read to the path /kv/k8s/$NAMESPACE<br><br>So if you namespace /pipline here then it will give read access to /kv/k8s/pipline<br><br></p>\n\n\n\n<pre class="wp-block-code"><code>ault write -tls-skip-verify auth/kubernetes/role/vault-$D_NAMESPACE bound_service_account_names=default bound_service_account_namespaces=$D_NAMESPACE policies=$D_NAMESPACE ttl=24h</code></pre>\n\n\n\n<p><br>Now we are creating a role that have the policy added before and the role is locked in k8s. so it must be the service account of defalt (Stanard when you deploy) and it need to be in the namespace we set before example &#8220;pipline&#8221;</p>\n\n\n\n<pre class="wp-block-code"><code>cat $VALUESFILE | yq . | vault kv put  -tls-skip-verify /kv/k8s/$D_NAMESPACE -</code></pre>\n\n\n\n<p>This is a small hack that take the values.yaml from my helm charts and konvert them into json and upload them as secrets.<br>So I get some data in vault and it gets easy to find where you put you data.</p>\n\n\n\n<h3 class="wp-block-heading">Secrets to pod</h3>\n\n\n\n<p>Now we need to install the vault-hook. It detects that we want some secrets from vault and injects a script that will connect to vault. Get the tokens and add the secrets as ENV in your pod.<br><br>You need to have the banziacloud helm repo added</p>\n\n\n\n<pre class="wp-block-code"><code>kubectl create namespace vault-hook\nhelm upgrade --namespace vault-hook --install vault-secrets-webhook banzaicloud-stable/vault-secrets-webhook --wait\n</code></pre>\n\n\n\n<p>Lets create a test pod</p>\n\n\n\n<pre class="wp-block-code"><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: hello-secrets\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: hello-secrets\n  template:\n    metadata:\n      labels:\n        app: hello-secrets\n      annotations:\n        vault.security.banzaicloud.io/vault-addr: "https://vault.vault.svc:8200"\n        vault.security.banzaicloud.io/vault-role: "vault-slackbot" # \n        vault.security.banzaicloud.io/vault-skip-verify: "true"\n\n\n\n    spec:\n      serviceAccountName: default\n      containers:\n      - name: alpine\n        image: alpine\n        command: &#91;"sh", "-c", "echo $AWS_SECRET_ACCESS_KEY &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000"]\n        env:\n        - name: AWS_SECRET_ACCESS_KEY\n          value: "vault:kv/k8s/slackbot#auth"</code></pre>\n\n\n\n<p>Here we have a pod that are called slackbot so what we need before this will work<br>&#8211; Have a policy grating access to /kv/k8s/slackbot <br>&#8211; Have a role that have access from service user default and namespace slackbot, And are using the policy <br>&#8211; A secrets in /kv/k8s/slackbot </p>\n\n\n\n<pre class="wp-block-code"><code>root@20927fd8e1e1:/code/setup# vault kv get -tls-skip-verify /kv/k8s/slackbot\nHandling connection for 8200\n======== Data ========\nKey             Value\n---             -----\nauth            2hsfsgffehgggs\ncluster         int\ndeployname      slackbot\ngitsha          latest\nreplicaCount    1\n</code></pre>\n\n\n\n<p>apply the tets pod in the slackbot namespace</p>\n\n\n\n<pre class="wp-block-code"><code>kubectl apply -f test_vault.yaml -n slackbot</code></pre>\n\n\n\n<p>Look in the logs to verify things are working </p>\n\n\n\n<pre class="wp-block-code"><code>root@20927fd8e1e1:/code/k8s/pre/vault/test# kubectl logs -f hello-secrets-7944dfcf86-rkrk6 -n slackbot\ntime="2020-10-29T07:09:30Z" level=info msg="received new Vault token" app=vault-env\ntime="2020-10-29T07:09:30Z" level=info msg="initial Vault token arrived" app=vault-env\ntime="2020-10-29T07:09:30Z" level=info msg="spawning process: &#91;sh -c echo $AWS_SECRET_ACCESS_KEY &amp;&amp; echo going to sleep... &amp;&amp; sleep 10000]" app=vault-env\n2hsfsgffehgggs\ngoing to sleep...\n</code></pre>\n', 'protected': False}</p>

            </div>
        </div>
    </section>


    <!-- Page Footer -->
    <footer class="page-footer">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-sm-6">
                    <p>Copyright <script>document.write(new Date().getFullYear())</script> &copy; <a href="http://hacking.robots.beer" target="_blank">Mattias Hemmingsson / h.r.b AB </a></p>
                </div>
                <div class="col-sm-6">
                    <div class="socials">
                        <a class="social-item" href="javascript:void(0)"><i class="ti-github"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </footer> 
    <!-- End of page footer -->
	
	<!-- core  -->
    <script src="/assets/vendors/jquery/jquery-3.4.1.js"></script>
    <script src="/assets/vendors/bootstrap/bootstrap.bundle.js"></script>
    <!-- bootstrap 3 affix -->
	<script src="/assets/vendors/bootstrap/bootstrap.affix.js"></script>

    <!-- steller js -->
    <script src="/assets/js/steller.js"></script>

</body>
</html>